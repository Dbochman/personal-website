# MDX Pipeline Centralization

> Plan generated by Codex Architect

## Bottom Line

Centralize all MDX handling behind a single typed content module fed by a zod-validated frontmatter schema. This removes the duplicated file-system parsing, gives feeds/OG metadata a shared source of truth, and keeps the existing precompile flow lightweight.

## Current State

MDX touchpoints to consolidate:
- `scripts/precompile-mdx.js`
- `src/lib/blog-loader-precompiled.ts`
- `scripts/generate-feeds.js`
- `tests/e2e/blog-rendering.spec.ts`
- `tests/e2e/console-errors.spec.ts`

## Action Plan

### 1. Create Zod Schema

Add `src/content/blog/schema.ts`:

```typescript
import { z } from 'zod';

export const blogFrontmatterSchema = z.object({
  title: z.string(),
  slug: z.string().optional(),
  date: z.string(),
  description: z.string(),
  tags: z.array(z.string()),
  author: z.enum(['Dylan', 'Claude']),
  draft: z.boolean(),
  featured: z.boolean().optional(),
  category: z.string().optional(),
  image: z.string().optional(),
  updated: z.string().optional(),
});

export type BlogFrontmatter = z.infer<typeof blogFrontmatterSchema>;
```

Update `src/types/blog.ts` to import/re-export the inferred types.

### 2. Convert Precompile Script to TypeScript

Convert `scripts/precompile-mdx.js` to `scripts/precompile-mdx.ts` (run with `tsx`):

```typescript
import { blogFrontmatterSchema } from '../src/content/blog/schema.js';

// Validate frontmatter before writing
const validated = blogFrontmatterSchema.parse({ slug: slugFromFilename, ...frontmatter });
```

Write manifest entry: `{ slug, frontmatter: validated, readingTime, compiledPath }`

### 3. Create Centralized Content Module

Replace `src/lib/blog-loader-precompiled.ts` with `src/content/blog/index.ts`:

```typescript
// Eager import all generated blog modules
const modules = import.meta.glob('/src/generated/blog/*.js', { eager: true });

// Expose typed helpers
export function getAllPosts({ includeDrafts = false } = {}) { ... }
export function getPostBySlug(slug: string) { ... }
export function getPostComponent(slug: string) { ... }

// Shared metadata helpers for RSS/OG
export function toRssItem(post: BlogPost) { ... }
export function toOgMeta(post: BlogPost) { ... }
```

### 4. Update Consumers

Update runtime consumers to import from `@/content/blog`:
- `src/pages/Blog.tsx`
- `src/pages/BlogPost.tsx`
- `src/components/blog/FeaturedHero.tsx`
- List/grid utilities

### 5. Refactor Build Scripts

Update `scripts/generate-feeds.ts`:

```typescript
import { getAllPosts, toRssItem } from '../src/content/blog';

const posts = getAllPosts({ includeDrafts: false });
const items = posts.map(toRssItem);
```

### 6. Add Tests

Add `src/content/blog/schema.test.ts` for zod parser validation.
Adjust Playwright slug discovery to call the new helper.

## Effort Estimate

**Medium** (1-2 days)

## Success Criteria

- [ ] Single source of truth for all blog post metadata
- [ ] Type-safe frontmatter validation at build time
- [ ] RSS/feeds and OG metadata share the same data
- [ ] Build fails fast on schema violations
