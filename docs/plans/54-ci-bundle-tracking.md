# CI Bundle Size Tracking

> Plan generated by Codex Architect

## Bottom Line

Use the `preactjs/compressed-size-action` in GitHub Actions to measure Vite's `dist/` output on every PR, compare it with the base branch, and warn (but not fail) when any asset grows more than 5%. This keeps the workflow simple, leverages existing tooling, and automatically maintains the baseline via the action's cached base-branch builds.

## Action Plan

### 1. Create Bundle Size Workflow

Add `.github/workflows/bundle-size.yml`:

```yaml
name: Bundle Size

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  bundle-size:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - run: npm ci

      - run: npm run build

      - name: Compare bundle size
        uses: preactjs/compressed-size-action@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          build-script: build
          pattern: |
            dist/assets/*.js
            dist/assets/*.css
          minimum-change-threshold: 10
          report-only: true
```

### 2. Add Warning Step for >5% Growth

```yaml
      - name: Warn on >5% growth
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const report = JSON.parse(
                fs.readFileSync('compressed-size-action-output.json', 'utf8')
              );
              for (const file of report.files ?? []) {
                if (file.diff && file.base > 0) {
                  const pct = (file.diff / file.base) * 100;
                  if (pct > 5) {
                    core.warning(
                      `${file.filename} grew by ${pct.toFixed(1)}% ` +
                      `(${file.diff} bytes). Please justify or optimize.`
                    );
                  }
                }
              }
            } catch (e) {
              // Report not available, skip warning
            }
```

### 3. Baseline Management

The workflow runs on `push` to `main` so the action refreshes its cached baseline:
- New PRs automatically compare against latest main
- No extra storage infrastructure needed
- Historical data available for trends

### 4. Documentation

Add to `CONTRIBUTING.md`:

```markdown
## Bundle Size Monitoring

Every PR is checked for bundle size changes:
- **Warning threshold**: >5% increase in any asset
- **Reports**: Size comparison comment added to PR
- **Expectation**: Justify or mitigate significant increases

To analyze locally:
\`\`\`bash
npm run build
npx source-map-explorer dist/assets/*.js
\`\`\`
```

## Effort Estimate

**Short** (1-4 hours)

## Success Criteria

- [ ] Bundle size workflow running on PRs
- [ ] Comparison comments appearing on PRs
- [ ] Warnings for >5% growth
- [ ] Baseline updates on main branch pushes
