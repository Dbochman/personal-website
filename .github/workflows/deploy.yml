name: Build, Test, and Deploy

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'content/blog/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache MDX compilation
        uses: actions/cache@v4
        with:
          path: .cache/mdx
          key: mdx-${{ hashFiles('scripts/precompile-mdx.ts', 'src/content/blog/schema.ts', 'content/blog/**/*.txt') }}
          restore-keys: |
            mdx-

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      - name: Install Playwright deps only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Security audit
        run: npm audit --audit-level=high

      - name: Run unit tests
        run: npm test

      - name: Build site
        run: npm run build
        env:
          GITHUB_SHA: ${{ github.sha }}

      - name: Upload source maps to Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: |
          npx sentry-cli releases new ${{ github.sha }}
          npx sentry-cli sourcemaps upload ./dist/assets --release=${{ github.sha }} --url-prefix '~/assets'
          npx sentry-cli releases finalize ${{ github.sha }}

      - name: Remove source maps from build
        run: find ./dist -name '*.map' -delete

      # Bundle size check uses raw (uncompressed) file sizes as a build guard.
      # This catches accidental bloat from new dependencies or unoptimized code.
      # Actual transfer sizes are ~70% smaller due to gzip/brotli compression.
      - name: Check bundle size budget
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          // Budgets: raw file sizes with ~15% headroom to catch regressions
          // Transfer sizes are ~70% smaller due to gzip compression
          // Note: Mermaid adds ~2MB for diagram support (flowchart, sequence, etc.)
          const BUDGETS = {
            totalJS: 4500 * 1024,     // 4.5MB raw (current ~4.3MB with Mermaid)
            totalCSS: 150 * 1024,     // 150KB raw (current ~140KB after Tailwind v4 upgrade)
            largestChunk: 500 * 1024, // 500KB raw (current ~480KB)
          };

          const distAssets = path.join('dist', 'assets');
          const files = fs.readdirSync(distAssets);

          let totalJS = 0, totalCSS = 0, largestChunk = 0;

          files.forEach(file => {
            const size = fs.statSync(path.join(distAssets, file)).size;
            if (file.endsWith('.js')) {
              totalJS += size;
              largestChunk = Math.max(largestChunk, size);
            }
            if (file.endsWith('.css')) totalCSS += size;
          });

          console.log('ðŸ“¦ Bundle Size Report:');
          console.log('  JS Total:       ' + (totalJS/1024).toFixed(1) + 'KB / ' + (BUDGETS.totalJS/1024) + 'KB');
          console.log('  CSS Total:      ' + (totalCSS/1024).toFixed(1) + 'KB / ' + (BUDGETS.totalCSS/1024) + 'KB');
          console.log('  Largest Chunk:  ' + (largestChunk/1024).toFixed(1) + 'KB / ' + (BUDGETS.largestChunk/1024) + 'KB');

          const failures = [];
          if (totalJS > BUDGETS.totalJS) failures.push('JS budget exceeded: ' + (totalJS/1024).toFixed(1) + 'KB > ' + (BUDGETS.totalJS/1024) + 'KB');
          if (totalCSS > BUDGETS.totalCSS) failures.push('CSS budget exceeded: ' + (totalCSS/1024).toFixed(1) + 'KB > ' + (BUDGETS.totalCSS/1024) + 'KB');

          if (failures.length > 0) {
            console.error('');
            console.error('âŒ Budget exceeded:');
            failures.forEach(f => console.error('  - ' + f));
            process.exit(1);
          }

          // Warnings (don't fail)
          if (largestChunk > BUDGETS.largestChunk) {
            console.warn('');
            console.warn('âš ï¸  Warning: Largest chunk exceeds soft limit: ' + (largestChunk/1024).toFixed(1) + 'KB > ' + (BUDGETS.largestChunk/1024) + 'KB');
          }

          console.log('');
          console.log('âœ… All budgets within limits');
          "

      - name: Start preview server
        run: npm run preview &
        env:
          CI: true

      - name: Wait for server to be ready
        run: npx wait-on http://localhost:4173 --timeout 30000

      - name: Run smoke tests
        run: BASE_URL=http://localhost:4173 npx playwright test --grep @smoke
        env:
          CI: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: ./dist
          retention-days: 1

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: playwright-report/
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          external_repository: Dbochman/dbochman.github.io
          publish_dir: ./dist
          publish_branch: main
          personal_token: ${{ secrets.DEPLOY_TOKEN }}
          force_orphan: true
          cname: dylanbochman.com
          commit_message: "deploy ðŸ“¦"
          user_name: "github-actions[bot]"
          user_email: "41898282+github-actions[bot]@users.noreply.github.com"
