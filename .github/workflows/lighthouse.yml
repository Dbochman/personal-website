name: Lighthouse CI

on:
  workflow_run:
    workflows: ["Build, Test, and Deploy"]
    types:
      - completed
  workflow_dispatch:
  schedule:
    # Run weekly on Mondays at 10 AM UTC (after SEO check)
    - cron: '0 10 * * 1'

jobs:
  lighthouse:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for deployment to be live
        if: github.event_name == 'workflow_run'
        run: |
          echo "Polling for deployment to be live..."
          for i in {1..20}; do
            if curl -sf https://dylanbochman.com > /dev/null 2>&1; then
              echo "Site is live after $((i * 5)) seconds"
              exit 0
            fi
            echo "Attempt $i: waiting 5 seconds..."
            sleep 5
          done
          echo "Site did not become available within 100 seconds"
          exit 1

      - name: Run Lighthouse on production (multi-page)
        run: node scripts/lighthouse-multi-page.mjs

      - name: Save Lighthouse reports
        run: |
          # Multi-page script generates lighthouse-reports/summary.json
          # Copy to docs/metrics for historical tracking
          mkdir -p docs/metrics
          cp lighthouse-reports/summary.json docs/metrics/latest-multi-page.json

          # Also save timestamp for tracking
          echo "{\"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"commit\": \"${{ github.sha }}\"}" > docs/metrics/last-run.json

      - name: Commit updated metrics to lighthouse-metrics branch
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Move files to temp location before branch switch
          mv lighthouse-reports /tmp/lighthouse-reports
          mv docs/metrics /tmp/metrics

          # Create or switch to lighthouse-metrics branch
          git fetch origin lighthouse-metrics:lighthouse-metrics 2>/dev/null || git checkout -b lighthouse-metrics
          git checkout lighthouse-metrics

          # Remove existing directories if they exist
          rm -rf lighthouse-reports docs/metrics

          # Move files back from temp location
          mv /tmp/lighthouse-reports lighthouse-reports
          mv /tmp/metrics docs/metrics

          # Add and commit if there are changes
          git add lighthouse-reports/ docs/metrics/
          git diff --staged --quiet || git commit -m "chore: update multi-page Lighthouse metrics [skip ci]"

          # Push to lighthouse-metrics branch
          git push origin lighthouse-metrics

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: |
            lighthouse-reports/
            docs/metrics/
          retention-days: 30

      - name: Check performance thresholds (multi-page)
        id: threshold_check
        run: |
          node -e "
          const fs = require('fs');
          const summary = JSON.parse(fs.readFileSync('./lighthouse-reports/summary.json', 'utf8'));

          console.log('ðŸ“Š Multi-Page Lighthouse Scores:\\n');
          console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”');
          console.log('â”‚ Page            â”‚ Perf â”‚ A11y â”‚ SEO â”‚ Best  â”‚');
          console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤');

          const failures = [];
          summary.forEach(page => {
            const pageName = page.page.padEnd(15);
            const perf = String(page.performance).padStart(4);
            const a11y = String(page.accessibility).padStart(4);
            const seo = String(page.seo).padStart(3);
            const best = String(page.bestPractices).padStart(5);
            console.log(\`â”‚ \${pageName} â”‚ \${perf} â”‚ \${a11y} â”‚ \${seo} â”‚ \${best} â”‚\`);

            // Check thresholds per page
            if (page.performance < 50) failures.push(\`\${page.page}: Performance \${page.performance} < 50\`);
            if (page.accessibility < 95) failures.push(\`\${page.page}: Accessibility \${page.accessibility} < 95\`);
            if (page.seo < 90) failures.push(\`\${page.page}: SEO \${page.seo} < 90\`);
            if (page.bestPractices < 90) failures.push(\`\${page.page}: Best Practices \${page.bestPractices} < 90\`);
          });

          console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜\\n');

          if (failures.length > 0) {
            console.error('âŒ Lighthouse thresholds not met:\\n');
            failures.forEach(f => console.error(\`   - \${f}\`));
            console.error('\\nðŸ“ Thresholds: Performance â‰¥50, Accessibility â‰¥95, SEO â‰¥90, Best Practices â‰¥90');
            process.exit(1);
          } else {
            console.log('âœ… All pages passed Lighthouse thresholds!');
          }
          "

      - name: Create issue for performance degradation
        if: failure() && steps.threshold_check.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('./lighthouse-reports/summary.json', 'utf8'));
            const date = new Date().toISOString().split('T')[0];

            // Build scores table
            let scoresTable = `| Page | Performance | Accessibility | SEO | Best Practices |\n`;
            scoresTable += `|------|-------------|---------------|-----|----------------|\n`;

            summary.forEach(page => {
              const perfStatus = page.performance >= 50 ? 'âœ…' : 'âŒ';
              const a11yStatus = page.accessibility >= 95 ? 'âœ…' : 'âŒ';
              const seoStatus = page.seo >= 90 ? 'âœ…' : 'âŒ';
              const bpStatus = page.bestPractices >= 90 ? 'âœ…' : 'âŒ';

              scoresTable += `| ${page.page} | ${page.performance} ${perfStatus} | ${page.accessibility} ${a11yStatus} | ${page.seo} ${seoStatus} | ${page.bestPractices} ${bpStatus} |\n`;
            });

            // Build Core Web Vitals table
            let vitalsTable = `| Page | LCP | FCP | CLS | TBT |\n`;
            vitalsTable += `|------|-----|-----|-----|-----|\n`;

            summary.forEach(page => {
              vitalsTable += `| ${page.page} | ${page.lcp} | ${page.fcp} | ${page.cls} | ${page.tbt} |\n`;
            });

            const body = `## ðŸ“‰ Multi-Page Lighthouse Performance Alert

            **Date:** ${date}
            **Base URL:** https://dylanbochman.com

            ### Scores by Page
            ${scoresTable}

            **Thresholds:** Performance â‰¥50 (CI), Accessibility â‰¥95, SEO â‰¥90, Best Practices â‰¥90

            > **Note:** Performance threshold is 50 for CI environment due to high variability. Local tests achieve 70-99 scores depending on page complexity.

            ### Core Web Vitals
            ${vitalsTable}

            ### Pages Tested
            ${summary.map(p => `- **${p.page}**: ${p.url}`).join('\n')}

            ### Actions Required
            1. Review the [Lighthouse reports artifact](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. Check detailed reports in \`lighthouse-reports/\` directory
            3. Investigate pages with failing scores
            4. Review [metrics history](${context.payload.repository.html_url}/tree/lighthouse-metrics/lighthouse-reports) on lighthouse-metrics branch

            ---
            *This issue was automatically created by the Multi-Page Lighthouse CI workflow.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Multi-Page Lighthouse Performance Degradation (${date})`,
              body: body,
              labels: ['performance', 'lighthouse', 'automated']
            });
