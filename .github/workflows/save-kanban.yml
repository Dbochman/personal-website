name: Save Kanban Board

on:
  repository_dispatch:
    types: [save-kanban]

jobs:
  save:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Validate boardId
        run: |
          BOARD_ID="${{ github.event.client_payload.boardId }}"
          # Whitelist of allowed board IDs (prevent path traversal)
          if [[ "$BOARD_ID" != "roadmap" && "$BOARD_ID" != "house" ]]; then
            echo "Error: Invalid boardId '$BOARD_ID'. Must be 'roadmap' or 'house'."
            exit 1
          fi
          echo "BOARD_ID=$BOARD_ID" >> $GITHUB_ENV

      - name: Log incoming board summary
        env:
          BOARD_JSON: ${{ toJson(github.event.client_payload.board) }}
        run: |
          echo "=== Incoming Board Summary ==="
          echo "Board: ${{ github.event.client_payload.boardId }}"
          echo "Base updatedAt: ${{ github.event.client_payload.baseUpdatedAt }}"
          echo ""
          echo "Cards by column:"
          printenv BOARD_JSON | jq -r '.columns[] | "\(.title): \([.cards[].title] | join(", "))"'
          echo ""

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEPLOY_TOKEN }}

      - name: Check for conflicts
        run: |
          FILE="public/data/${{ env.BOARD_ID }}-board.json"
          BASE_UPDATED="${{ github.event.client_payload.baseUpdatedAt }}"

          # Validate baseUpdatedAt is present
          if [ -z "$BASE_UPDATED" ]; then
            echo "Error: baseUpdatedAt is required for conflict detection."
            echo "This may indicate an outdated client. Please reload the page."
            exit 1
          fi

          if [ -f "$FILE" ]; then
            CURRENT_UPDATED=$(jq -r '.updatedAt // "1970-01-01"' "$FILE")

            # If file is newer than what user originally loaded, reject
            if [[ "$CURRENT_UPDATED" > "$BASE_UPDATED" ]]; then
              echo "Error: Board has been updated since you loaded it."
              echo "  File updatedAt: $CURRENT_UPDATED"
              echo "  Your baseUpdatedAt: $BASE_UPDATED"
              echo "Please reload the page and try again."
              exit 1
            fi
          fi

      - name: Update board JSON
        env:
          BOARD_JSON: ${{ toJson(github.event.client_payload.board) }}
        run: |
          mkdir -p public/data
          printenv BOARD_JSON | jq '.' > public/data/${{ env.BOARD_ID }}-board.json

      - name: Archive old changelog entries (roadmap only)
        if: env.BOARD_ID == 'roadmap'
        run: |
          BOARD_FILE="public/data/roadmap-board.json"
          ARCHIVE_FILE="public/data/roadmap-archive.json"
          MAX_CHANGELOG=10

          # Get changelog column (last column)
          CHANGELOG_COUNT=$(jq '.columns[-1].cards | length' "$BOARD_FILE")
          echo "Changelog has $CHANGELOG_COUNT cards"

          if [ "$CHANGELOG_COUNT" -gt "$MAX_CHANGELOG" ]; then
            echo "Archiving $(($CHANGELOG_COUNT - $MAX_CHANGELOG)) cards..."

            # Extract cards to archive (beyond first 10)
            CARDS_TO_ARCHIVE=$(jq '.columns[-1].cards['"$MAX_CHANGELOG"':]' "$BOARD_FILE")

            # Create or update archive file
            if [ -f "$ARCHIVE_FILE" ]; then
              # Append to existing archive
              jq --argjson newCards "$CARDS_TO_ARCHIVE" '
                .archivedAt = (now | strftime("%Y-%m-%dT%H:%M:%SZ")) |
                .cards = (.cards + $newCards)
              ' "$ARCHIVE_FILE" > "${ARCHIVE_FILE}.tmp" && mv "${ARCHIVE_FILE}.tmp" "$ARCHIVE_FILE"
            else
              # Create new archive
              echo "$CARDS_TO_ARCHIVE" | jq '{
                archivedAt: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
                cards: .
              }' > "$ARCHIVE_FILE"
            fi

            # Trim changelog to MAX_CHANGELOG items
            jq '.columns[-1].cards = .columns[-1].cards[:'"$MAX_CHANGELOG"']' "$BOARD_FILE" > "${BOARD_FILE}.tmp" \
              && mv "${BOARD_FILE}.tmp" "$BOARD_FILE"

            echo "Archived cards. Changelog now has $MAX_CHANGELOG cards."
          else
            echo "No archiving needed."
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/*-board.json public/data/roadmap-archive.json 2>/dev/null || true
          git diff --staged --quiet || git commit -m "kanban: save board state"
          git push
