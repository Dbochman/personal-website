name: Codex PR Review

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, closed]

# Cancel in-progress runs when new commits are pushed OR when PR is closed/merged
concurrency:
  group: codex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Skip review entirely if PR was closed/merged - concurrency will cancel in-progress runs
  review:
    runs-on: ubuntu-latest
    # Skip if PR is closed/merged, from dependabot, or has [skip-review] in title
    # When PR closes, the concurrency group cancels in-progress runs
    if: |
      github.event.action != 'closed' &&
      github.actor != 'dependabot[bot]' &&
      !contains(github.event.pull_request.title, '[skip-review]')

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Check for code changes
        id: check
        run: |
          # Check if there are code changes (not just docs/config)
          CHANGES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD \
            -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.css' \
            ':!*.config.*' ':!*.d.ts' | wc -l)
          if [ "$CHANGES" -eq 0 ]; then
            echo "has_code=false" >> $GITHUB_OUTPUT
          else
            echo "has_code=true" >> $GITHUB_OUTPUT
          fi

      - name: Run Codex review
        if: steps.check.outputs.has_code == 'true'
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Authenticate with API key
          echo "$OPENAI_API_KEY" | codex login --with-api-key

          # Generate the diff for context
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt

          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20)

          # Use codex exec with a direct prompt (not the review subcommand)
          # The review subcommand doesn't output a message, so we use exec directly
          cat << 'REVIEW_PROMPT' | codex exec \
            --json \
            -o findings.txt \
            -s read-only \
            - \
            > review_events.jsonl 2>&1 || true
          You are reviewing a pull request titled: "${{ github.event.pull_request.title }}"

          Review the code changes in this repository. The diff has been saved to pr_diff.txt.
          Read the diff file and analyze the changes.

          Provide a code review with:
          1. **Summary**: What this PR does (1-2 sentences)
          2. **Review**: Any issues, concerns, or suggestions
          3. **Verdict**: LGTM, Needs Changes, or Needs Discussion

          Be concise and focus on substantive issues. Skip style nitpicks.
          REVIEW_PROMPT

          # Fallback if Codex didn't produce output
          if [ ! -s findings.txt ]; then
            echo "Review completed - see workflow logs for details." > findings.txt
          fi

      - name: Post review comment
        if: steps.check.outputs.has_code == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Clean up file paths (remove /home/runner/work/.../... prefix)
          sed -i 's|/home/runner/work/[^/]*/[^/]*/||g' findings.txt

          # Build comment with header
          {
            echo "## ðŸ¤– Codex Review"
            echo ""
            cat findings.txt
            echo ""
            echo "---"
            echo "<sub>Automated review by OpenAI Codex â€¢ Skip by adding \`[skip-review]\` to PR title</sub>"
          } > comment.txt

          # Post as PR comment
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.txt

      - name: Skip comment for non-code changes
        if: steps.check.outputs.has_code != 'true'
        run: echo "No code changes to review (docs/config only)"
