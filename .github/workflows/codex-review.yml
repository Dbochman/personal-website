name: Codex PR Review

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]

# Don't review docs-only changes
concurrency:
  group: codex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    # Skip if PR is from dependabot or has [skip-review] in title
    if: |
      github.actor != 'dependabot[bot]' &&
      !contains(github.event.pull_request.title, '[skip-review]')

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Check for code changes
        id: check
        run: |
          # Check if there are code changes (not just docs/config)
          CHANGES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD \
            -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.css' \
            ':!*.config.*' ':!*.d.ts' | wc -l)
          if [ "$CHANGES" -eq 0 ]; then
            echo "has_code=false" >> $GITHUB_OUTPUT
          else
            echo "has_code=true" >> $GITHUB_OUTPUT
          fi

      - name: Run Codex review
        if: steps.check.outputs.has_code == 'true'
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Authenticate with API key
          echo "$OPENAI_API_KEY" | codex login --with-api-key

          # Use codex exec review with JSON output for structured parsing
          # --json and -o are global flags for `codex exec`, must come BEFORE the subcommand
          # --json outputs newline-delimited JSON events (JSONL stream)
          # -o writes the final message to a file for reliable extraction
          codex exec \
            --json \
            -o findings.txt \
            review \
            --base origin/${{ github.base_ref }} \
            --title "${{ github.event.pull_request.title }}" \
            > review_events.jsonl 2>&1 || true

          # Fallback: if -o didn't produce output, extract from JSONL events
          if [ ! -s findings.txt ]; then
            # Extract agent message content from JSONL events
            # Look for item.message.delta or item.message events with content
            if [ -s review_events.jsonl ]; then
              jq -rs '
                [.[] | select(.type == "item.message" or .type == "item.message.delta")
                     | .content // .delta // empty]
                | add // "No findings extracted from review."
              ' review_events.jsonl > findings.txt 2>/dev/null || true
            fi
          fi

          # Final fallback if still empty
          if [ ! -s findings.txt ]; then
            echo "Review completed - see workflow logs for details." > findings.txt
          fi

      - name: Post review comment
        if: steps.check.outputs.has_code == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Clean up file paths (remove /home/runner/work/.../... prefix)
          sed -i 's|/home/runner/work/[^/]*/[^/]*/||g' findings.txt

          # Build comment with header
          {
            echo "## ðŸ¤– Codex Review"
            echo ""
            cat findings.txt
            echo ""
            echo "---"
            echo "<sub>Automated review by OpenAI Codex â€¢ Skip by adding \`[skip-review]\` to PR title</sub>"
          } > comment.txt

          # Post as PR comment
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.txt

      - name: Skip comment for non-code changes
        if: steps.check.outputs.has_code != 'true'
        run: echo "No code changes to review (docs/config only)"
