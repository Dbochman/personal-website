name: Codex PR Review

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]

# Don't review docs-only changes
concurrency:
  group: codex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    # Skip if PR is from dependabot or has [skip-review] in title
    if: |
      github.actor != 'dependabot[bot]' &&
      !contains(github.event.pull_request.title, '[skip-review]')

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Check for code changes
        id: check
        run: |
          # Check if there are code changes (not just docs/config)
          CHANGES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD \
            -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.css' \
            ':!*.config.*' ':!*.d.ts' | wc -l)
          if [ "$CHANGES" -eq 0 ]; then
            echo "has_code=false" >> $GITHUB_OUTPUT
          else
            echo "has_code=true" >> $GITHUB_OUTPUT
          fi

      - name: Run Codex review
        if: steps.check.outputs.has_code == 'true'
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Authenticate with API key
          echo "$OPENAI_API_KEY" | codex login --with-api-key

          # Use codex exec review with JSON output for structured parsing
          # --json and -o are global flags for `codex exec`, must come BEFORE the subcommand
          # --json outputs newline-delimited JSON events (JSONL stream)
          # -o writes the final message to a file for reliable extraction
          # A PROMPT is required to tell Codex to output a summary (otherwise it only runs commands)
          codex exec \
            --json \
            -o findings.txt \
            review \
            --base origin/${{ github.base_ref }} \
            --title "${{ github.event.pull_request.title }}" \
            "Review the code changes and provide a summary of any issues, suggestions, or concerns. Format your response as a code review with sections for: 1) Summary, 2) Issues Found (if any), 3) Suggestions (if any). Be concise." \
            > review_events.jsonl 2>&1 || true

          # Debug: show what we got
          echo "=== Debug: findings.txt exists? ==="
          ls -la findings.txt 2>&1 || echo "findings.txt not found"
          echo "=== Debug: review_events.jsonl stats ==="
          wc -l review_events.jsonl 2>&1 || echo "review_events.jsonl not found"
          echo "=== Debug: Event types in JSONL ==="
          jq -r '.type // "no-type"' review_events.jsonl 2>/dev/null | sort | uniq -c | head -20 || echo "No valid JSON"
          echo "=== Debug: Sample events ==="
          head -5 review_events.jsonl 2>/dev/null || echo "No events"
          echo "=== Debug: Last 5 events ==="
          tail -5 review_events.jsonl 2>/dev/null || echo "No events"

          # Fallback: if -o didn't produce output, extract from JSONL events
          if [ ! -s findings.txt ]; then
            echo "=== -o flag didn't produce output, trying JSONL extraction ==="
            # Extract agent message content from JSONL events
            # Try multiple possible event structures
            if [ -s review_events.jsonl ]; then
              # Try to find message content in various event formats
              jq -rs '
                [.[] |
                  # Try different possible structures
                  (.message.content // .content // .text // .delta.text // .delta // empty)
                  | select(. != null and . != "")
                ] | join("") | if . == "" then "No content found in events" else . end
              ' review_events.jsonl > findings.txt 2>/dev/null || true

              echo "=== Debug: Extracted content length ==="
              wc -c findings.txt
            fi
          fi

          # Final fallback if still empty
          if [ ! -s findings.txt ]; then
            echo "Review completed - see workflow logs for details." > findings.txt
          fi

      - name: Post review comment
        if: steps.check.outputs.has_code == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Clean up file paths (remove /home/runner/work/.../... prefix)
          sed -i 's|/home/runner/work/[^/]*/[^/]*/||g' findings.txt

          # Build comment with header
          {
            echo "## ðŸ¤– Codex Review"
            echo ""
            cat findings.txt
            echo ""
            echo "---"
            echo "<sub>Automated review by OpenAI Codex â€¢ Skip by adding \`[skip-review]\` to PR title</sub>"
          } > comment.txt

          # Post as PR comment
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.txt

      - name: Skip comment for non-code changes
        if: steps.check.outputs.has_code != 'true'
        run: echo "No code changes to review (docs/config only)"
